<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>API Key èª¿è©¦é é¢</title>
  <script defer="defer" src="./api-key-integration.js"></script>
  <script defer="defer" src="./api-key-fix.js"></script>
  <script defer="defer" src="./api-key-setup.js"></script>
  <script defer="defer" src="./api-key-manager.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 2rem;
    }
    .status {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      font-weight: 500;
    }
    .status.valid {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.invalid {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background: #e7f3ff;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      border: 1px solid #b3d9ff;
    }
    .button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      margin: 0.5rem;
      transition: background-color 0.3s;
    }
    .button:hover {
      background: #0056b3;
    }
    .button.danger {
      background: #dc3545;
    }
    .button.danger:hover {
      background: #c82333;
    }
    .button.success {
      background: #28a745;
    }
    .button.success:hover {
      background: #218838;
    }
    .button.warning {
      background: #ffc107;
      color: #212529;
    }
    .button.warning:hover {
      background: #e0a800;
    }
    .code {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      margin: 1rem 0;
      border: 1px solid #e9ecef;
      white-space: pre-wrap;
    }
    .log {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 6px;
      margin: 1rem 0;
      border: 1px solid #e9ecef;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin: 2rem 0;
    }
    .section {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ API Key èª¿è©¦é é¢</h1>
    
    <div id="status" class="status">
      æ­£åœ¨æª¢æŸ¥ API Key ç‹€æ…‹...
    </div>
    
    <div class="info">
      <h3>ğŸ“‹ èª¿è©¦èªªæ˜</h3>
      <p>é€™å€‹é é¢ç”¨æ–¼èª¿è©¦ API Key è¨­ç½®å’Œä¿®å¾©åŠŸèƒ½ã€‚</p>
      <ul>
        <li>æª¢æŸ¥ localStorage ä¸­çš„ API Key</li>
        <li>æ¸¬è©¦ä¿®å¾©è…³æœ¬æ˜¯å¦æ­£å¸¸å·¥ä½œ</li>
        <li>æ¨¡æ“¬æ‡‰ç”¨ç¨‹å¼çš„ API Key æª¢æŸ¥</li>
        <li>æŸ¥çœ‹è©³ç´°çš„èª¿è©¦æ—¥èªŒ</li>
      </ul>
    </div>
    
    <div class="grid">
      <div class="section">
        <h3>ğŸ” ç‹€æ…‹æª¢æŸ¥</h3>
        <button class="button" onclick="checkStatus()">æª¢æŸ¥ç‹€æ…‹</button>
        <button class="button success" onclick="testGetApiKey()">æ¸¬è©¦ getApiKey()</button>
        <button class="button warning" onclick="testFix()">æ¸¬è©¦ä¿®å¾©åŠŸèƒ½</button>
        <div id="statusOutput" class="code">é»æ“ŠæŒ‰éˆ•é–‹å§‹æ¸¬è©¦...</div>
      </div>
      
      <div class="section">
        <h3>ğŸ”§ ä¿®å¾©å·¥å…·</h3>
        <button class="button success" onclick="setTestApiKey()">è¨­ç½®æ¸¬è©¦ API Key</button>
        <button class="button danger" onclick="clearApiKey()">æ¸…é™¤ API Key</button>
        <button class="button warning" onclick="forceFix()">å¼·åˆ¶ä¿®å¾©</button>
        <div id="fixOutput" class="code">é»æ“ŠæŒ‰éˆ•é–‹å§‹ä¿®å¾©...</div>
      </div>
    </div>
    
    <div class="section">
      <h3>ğŸ“ èª¿è©¦æ—¥èªŒ</h3>
      <button class="button" onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
      <button class="button" onclick="exportLog()">åŒ¯å‡ºæ—¥èªŒ</button>
      <div id="debugLog" class="log">èª¿è©¦æ—¥èªŒå°‡åœ¨é€™è£¡é¡¯ç¤º...</div>
    </div>
    
    <div class="section">
      <h3>ğŸ§ª æ¨¡æ“¬æ¸¬è©¦</h3>
      <button class="button" onclick="simulateError()">æ¨¡æ“¬éŒ¯èª¤</button>
      <button class="button" onclick="simulateAppCheck()">æ¨¡æ“¬æ‡‰ç”¨ç¨‹å¼æª¢æŸ¥</button>
      <button class="button" onclick="testIntegration()">æ¸¬è©¦æ•´åˆ</button>
      <div id="simulationOutput" class="code">æ¨¡æ“¬æ¸¬è©¦çµæœå°‡åœ¨é€™è£¡é¡¯ç¤º...</div>
    </div>
  </div>

  <script>
    let logMessages = [];
    
    // æ·»åŠ æ—¥èªŒ
    function addLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
      logMessages.push(logEntry);
      
      const logDiv = document.getElementById('debugLog');
      logDiv.textContent = logMessages.join('\n');
      logDiv.scrollTop = logDiv.scrollHeight;
      
      console.log(logEntry);
    }
    
    // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
    function updateStatus() {
      const apiKey = localStorage.getItem('google_ai_api_key') || '';
      const statusDiv = document.getElementById('status');
      const isValid = apiKey && apiKey.length >= 30;
      
      statusDiv.className = `status ${isValid ? 'valid' : 'invalid'}`;
      statusDiv.innerHTML = isValid 
        ? `âœ… API Key å·²è¨­ç½®ä¸”æ ¼å¼æ­£ç¢º (${apiKey.length} å€‹å­—ç¬¦)`
        : `âŒ API Key æœªè¨­ç½®æˆ–æ ¼å¼ä¸æ­£ç¢º (ç•¶å‰: ${apiKey.length} å€‹å­—ç¬¦)`;
        
      addLog(`ç‹€æ…‹æ›´æ–°: ${isValid ? 'æœ‰æ•ˆ' : 'ç„¡æ•ˆ'} API Key`);
    }
    
    // æª¢æŸ¥ç‹€æ…‹
    function checkStatus() {
      const output = document.getElementById('statusOutput');
      const apiKey = localStorage.getItem('google_ai_api_key') || '';
      const isValid = apiKey && apiKey.length >= 30;
      
      let result = `API Key ç‹€æ…‹æª¢æŸ¥:\n`;
      result += `- localStorage ä¸­çš„ key: ${apiKey ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}\n`;
      result += `- key é•·åº¦: ${apiKey.length} å€‹å­—ç¬¦\n`;
      result += `- æ ¼å¼é©—è­‰: ${isValid ? 'é€šé' : 'å¤±æ•—'}\n`;
      result += `- å…¨å±€ getApiKey å‡½æ•¸: ${typeof window.getApiKey === 'function' ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}\n`;
      
      if (window.getApiKey) {
        const globalKey = window.getApiKey();
        result += `- å…¨å±€å‡½æ•¸è¿”å›å€¼: ${globalKey ? 'æœ‰æ•ˆ' : 'ç„¡æ•ˆ'}\n`;
      }
      
      output.textContent = result;
      addLog('åŸ·è¡Œç‹€æ…‹æª¢æŸ¥');
    }
    
    // æ¸¬è©¦ getApiKey å‡½æ•¸
    function testGetApiKey() {
      const output = document.getElementById('statusOutput');
      let result = `getApiKey() å‡½æ•¸æ¸¬è©¦:\n`;
      
      if (typeof window.getApiKey === 'function') {
        try {
          const apiKey = window.getApiKey();
          result += `- å‡½æ•¸åŸ·è¡Œ: æˆåŠŸ\n`;
          result += `- è¿”å›å€¼: ${apiKey ? 'æœ‰æ•ˆ' : 'ç„¡æ•ˆ'}\n`;
          result += `- è¿”å›å€¼é•·åº¦: ${apiKey ? apiKey.length : 0} å€‹å­—ç¬¦\n`;
        } catch (error) {
          result += `- å‡½æ•¸åŸ·è¡Œ: å¤±æ•—\n`;
          result += `- éŒ¯èª¤: ${error.message}\n`;
        }
      } else {
        result += `- å‡½æ•¸å­˜åœ¨: å¦\n`;
      }
      
      output.textContent = result;
      addLog('æ¸¬è©¦ getApiKey å‡½æ•¸');
    }
    
    // æ¸¬è©¦ä¿®å¾©åŠŸèƒ½
    function testFix() {
      const output = document.getElementById('statusOutput');
      let result = `ä¿®å¾©åŠŸèƒ½æ¸¬è©¦:\n`;
      
      if (window.apiKeyFix) {
        result += `- apiKeyFix å°è±¡: å­˜åœ¨\n`;
        result += `- check() æ–¹æ³•: ${typeof window.apiKeyFix.check === 'function' ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}\n`;
        result += `- fix() æ–¹æ³•: ${typeof window.apiKeyFix.fix === 'function' ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}\n`;
        result += `- get() æ–¹æ³•: ${typeof window.apiKeyFix.get === 'function' ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}\n`;
        
        if (window.apiKeyFix.check) {
          const isValid = window.apiKeyFix.check();
          result += `- æª¢æŸ¥çµæœ: ${isValid ? 'æœ‰æ•ˆ' : 'ç„¡æ•ˆ'}\n`;
        }
      } else {
        result += `- apiKeyFix å°è±¡: ä¸å­˜åœ¨\n`;
      }
      
      if (window.fixApiKeyIssue) {
        result += `- fixApiKeyIssue å‡½æ•¸: å­˜åœ¨\n`;
      } else {
        result += `- fixApiKeyIssue å‡½æ•¸: ä¸å­˜åœ¨\n`;
      }
      
      output.textContent = result;
      addLog('æ¸¬è©¦ä¿®å¾©åŠŸèƒ½');
    }
    
    // è¨­ç½®æ¸¬è©¦ API Key
    function setTestApiKey() {
      const output = document.getElementById('fixOutput');
      const testKey = 'test-api-key-' + Date.now() + '-very-long-key-for-testing';
      localStorage.setItem('google_ai_api_key', testKey);
      
      output.textContent = `è¨­ç½®æ¸¬è©¦ API Key:\n- Key: ${testKey}\n- é•·åº¦: ${testKey.length} å€‹å­—ç¬¦\n- ç‹€æ…‹: å·²ä¿å­˜`;
      
      updateStatus();
      addLog('è¨­ç½®æ¸¬è©¦ API Key');
    }
    
    // æ¸…é™¤ API Key
    function clearApiKey() {
      const output = document.getElementById('fixOutput');
      localStorage.removeItem('google_ai_api_key');
      
      output.textContent = `æ¸…é™¤ API Key:\n- ç‹€æ…‹: å·²æ¸…é™¤\n- localStorage: å·²æ¸…ç©º`;
      
      updateStatus();
      addLog('æ¸…é™¤ API Key');
    }
    
    // å¼·åˆ¶ä¿®å¾©
    function forceFix() {
      const output = document.getElementById('fixOutput');
      let result = `å¼·åˆ¶ä¿®å¾©åŸ·è¡Œ:\n`;
      
      if (window.fixApiKeyIssue) {
        try {
          const success = window.fixApiKeyIssue();
          result += `- ä¿®å¾©å‡½æ•¸åŸ·è¡Œ: æˆåŠŸ\n`;
          result += `- ä¿®å¾©çµæœ: ${success ? 'æˆåŠŸ' : 'å¤±æ•—'}\n`;
        } catch (error) {
          result += `- ä¿®å¾©å‡½æ•¸åŸ·è¡Œ: å¤±æ•—\n`;
          result += `- éŒ¯èª¤: ${error.message}\n`;
        }
      } else {
        result += `- ä¿®å¾©å‡½æ•¸: ä¸å­˜åœ¨\n`;
      }
      
      if (window.apiKeyFix && window.apiKeyFix.fix) {
        try {
          const success = window.apiKeyFix.fix();
          result += `- apiKeyFix.fix() åŸ·è¡Œ: æˆåŠŸ\n`;
          result += `- ä¿®å¾©çµæœ: ${success ? 'æˆåŠŸ' : 'å¤±æ•—'}\n`;
        } catch (error) {
          result += `- apiKeyFix.fix() åŸ·è¡Œ: å¤±æ•—\n`;
          result += `- éŒ¯èª¤: ${error.message}\n`;
        }
      } else {
        result += `- apiKeyFix.fix() å‡½æ•¸: ä¸å­˜åœ¨\n`;
      }
      
      output.textContent = result;
      addLog('åŸ·è¡Œå¼·åˆ¶ä¿®å¾©');
    }
    
    // æ¨¡æ“¬éŒ¯èª¤
    function simulateError() {
      const output = document.getElementById('simulationOutput');
      addLog('æ¨¡æ“¬ API key éŒ¯èª¤');
      
      // æ¨¡æ“¬ console.error
      console.error('API keyæœªè¨­ç½®ï¼Œè«‹åœ¨é–‹ç™¼ç’°å¢ƒä¸­è¨­ç½®API key');
      
      output.textContent = `æ¨¡æ“¬éŒ¯èª¤åŸ·è¡Œ:\n- å·²è§¸ç™¼ console.error\n- éŒ¯èª¤è¨Šæ¯: API keyæœªè¨­ç½®ï¼Œè«‹åœ¨é–‹ç™¼ç’°å¢ƒä¸­è¨­ç½®API key\n- æª¢æŸ¥ä¿®å¾©è…³æœ¬æ˜¯å¦æª¢æ¸¬åˆ°éŒ¯èª¤`;
    }
    
    // æ¨¡æ“¬æ‡‰ç”¨ç¨‹å¼æª¢æŸ¥
    function simulateAppCheck() {
      const output = document.getElementById('simulationOutput');
      addLog('æ¨¡æ“¬æ‡‰ç”¨ç¨‹å¼ API key æª¢æŸ¥');
      
      // æ¨¡æ“¬æ‡‰ç”¨ç¨‹å¼çš„æª¢æŸ¥é‚è¼¯
      const apiKey = window.getApiKey ? window.getApiKey() : null;
      
      output.textContent = `æ¨¡æ“¬æ‡‰ç”¨ç¨‹å¼æª¢æŸ¥:\n- èª¿ç”¨ getApiKey(): ${apiKey ? 'æˆåŠŸ' : 'å¤±æ•—'}\n- è¿”å›å€¼: ${apiKey ? 'æœ‰æ•ˆ' : 'ç„¡æ•ˆ'}\n- è¿”å›å€¼é•·åº¦: ${apiKey ? apiKey.length : 0} å€‹å­—ç¬¦`;
    }
    
    // æ¸¬è©¦æ•´åˆ
    function testIntegration() {
      const output = document.getElementById('simulationOutput');
      addLog('æ¸¬è©¦ API key æ•´åˆ');
      
      let result = `æ•´åˆæ¸¬è©¦çµæœ:\n`;
      
      // æ¸¬è©¦æ‰€æœ‰ç›¸é—œå‡½æ•¸
      const functions = [
        'getApiKey',
        'setApiKey', 
        'isApiKeyValid',
        'fixApiKeyIssue',
        'apiKeyFix'
      ];
      
      functions.forEach(funcName => {
        const exists = typeof window[funcName] === 'function' || (funcName === 'apiKeyFix' && window[funcName]);
        result += `- ${funcName}: ${exists ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}\n`;
      });
      
      // æ¸¬è©¦ localStorage
      const localKey = localStorage.getItem('google_ai_api_key');
      result += `- localStorage ä¸­çš„ key: ${localKey ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}\n`;
      
      output.textContent = result;
    }
    
    // æ¸…é™¤æ—¥èªŒ
    function clearLog() {
      logMessages = [];
      document.getElementById('debugLog').textContent = 'æ—¥èªŒå·²æ¸…é™¤...';
    }
    
    // åŒ¯å‡ºæ—¥èªŒ
    function exportLog() {
      const logText = logMessages.join('\n');
      const blob = new Blob([logText], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'api-key-debug-log.txt';
      a.click();
      URL.revokeObjectURL(url);
      addLog('åŒ¯å‡ºèª¿è©¦æ—¥èªŒ');
    }
    
    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      addLog('èª¿è©¦é é¢å·²è¼‰å…¥');
      updateStatus();
      
      // å®šæœŸæ›´æ–°ç‹€æ…‹
      setInterval(updateStatus, 5000);
    });
  </script>
</body>
</html>
