<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>API Key 測試頁面</title>
  <script src="./api-key-final.js"></script>
  <script src="./api-key-urgent.js"></script>
  <script defer="defer" src="./api-key-simple.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 2rem;
    }
    .status {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      font-weight: 500;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    .button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      margin: 0.5rem;
      transition: background-color 0.3s;
    }
    .button:hover {
      background: #0056b3;
    }
    .button.success {
      background: #28a745;
    }
    .button.success:hover {
      background: #218838;
    }
    .button.danger {
      background: #dc3545;
    }
    .button.danger:hover {
      background: #c82333;
    }
    .output {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 6px;
      margin: 1rem 0;
      border: 1px solid #e9ecef;
      font-family: 'Courier New', monospace;
      white-space: pre-wrap;
    }
    .test-section {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 8px;
      margin: 1rem 0;
      border: 1px solid #e9ecef;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🔧 API Key 執行測試</h1>
    
    <div id="status" class="status">
      正在檢查 API Key 狀態...
    </div>
    
    <div class="test-section">
      <h3>🧪 基本測試</h3>
      <button class="button" onclick="testBasic()">基本功能測試</button>
      <button class="button success" onclick="testGetApiKey()">測試 getApiKey()</button>
      <button class="button" onclick="testLocalStorage()">測試 localStorage</button>
      <div id="basicOutput" class="output">點擊按鈕開始測試...</div>
    </div>
    
    <div class="test-section">
      <h3>🔧 修復測試</h3>
      <button class="button success" onclick="testFinalFix()">測試最終修復</button>
      <button class="button" onclick="testUrgentFix()">測試緊急修復</button>
      <button class="button" onclick="testSimpleFix()">測試簡單修復</button>
      <div id="fixOutput" class="output">點擊按鈕開始測試...</div>
    </div>
    
    <div class="test-section">
      <h3>🚨 錯誤模擬測試</h3>
      <button class="button danger" onclick="simulateError()">模擬 API key 錯誤</button>
      <button class="button" onclick="simulateAppCheck()">模擬應用程式檢查</button>
      <button class="button" onclick="testErrorInterception()">測試錯誤攔截</button>
      <div id="errorOutput" class="output">點擊按鈕開始測試...</div>
    </div>
    
    <div class="test-section">
      <h3>📊 詳細狀態</h3>
      <button class="button" onclick="showDetailedStatus()">顯示詳細狀態</button>
      <button class="button" onclick="clearAll()">清除所有測試</button>
      <div id="detailedOutput" class="output">點擊按鈕查看詳細狀態...</div>
    </div>
  </div>

  <script>
    // 更新狀態顯示
    function updateStatus() {
      const apiKey = localStorage.getItem('google_ai_api_key') || '';
      const statusDiv = document.getElementById('status');
      const isValid = apiKey && apiKey.length >= 30;
      
      if (isValid) {
        statusDiv.className = 'status success';
        statusDiv.innerHTML = `✅ API Key 已設置且格式正確 (${apiKey.length} 個字符)`;
      } else {
        statusDiv.className = 'status error';
        statusDiv.innerHTML = `❌ API Key 未設置或格式不正確 (當前: ${apiKey.length} 個字符)`;
      }
    }
    
    // 基本功能測試
    function testBasic() {
      const output = document.getElementById('basicOutput');
      let result = `🔍 基本功能測試:\n`;
      
      // 檢查 localStorage
      const apiKey = localStorage.getItem('google_ai_api_key');
      result += `- localStorage 中的 key: ${apiKey ? '存在' : '不存在'}\n`;
      result += `- key 長度: ${apiKey ? apiKey.length : 0} 個字符\n`;
      result += `- 格式驗證: ${apiKey && apiKey.length >= 30 ? '通過' : '失敗'}\n`;
      
      // 檢查全局函數
      result += `- window.getApiKey: ${typeof window.getApiKey === 'function' ? '存在' : '不存在'}\n`;
      result += `- window.finalApiKeyFix: ${typeof window.finalApiKeyFix === 'function' ? '存在' : '不存在'}\n`;
      result += `- window.urgentApiKeyFix: ${typeof window.urgentApiKeyFix === 'function' ? '存在' : '不存在'}\n`;
      
      output.textContent = result;
      updateStatus();
    }
    
    // 測試 getApiKey 函數
    function testGetApiKey() {
      const output = document.getElementById('basicOutput');
      let result = `🔍 getApiKey() 函數測試:\n`;
      
      if (typeof window.getApiKey === 'function') {
        try {
          const apiKey = window.getApiKey();
          result += `- 函數執行: 成功\n`;
          result += `- 返回值: ${apiKey ? '有效' : '無效'}\n`;
          result += `- 返回值長度: ${apiKey ? apiKey.length : 0} 個字符\n`;
          
          if (apiKey) {
            result += `- 返回值前10個字符: ${apiKey.substring(0, 10)}...\n`;
          }
        } catch (error) {
          result += `- 函數執行: 失敗\n`;
          result += `- 錯誤: ${error.message}\n`;
        }
      } else {
        result += `- 函數存在: 否\n`;
      }
      
      output.textContent = result;
    }
    
    // 測試 localStorage
    function testLocalStorage() {
      const output = document.getElementById('basicOutput');
      let result = `🔍 localStorage 測試:\n`;
      
      const apiKey = localStorage.getItem('google_ai_api_key');
      result += `- 直接讀取: ${apiKey ? '成功' : '失敗'}\n`;
      result += `- 值: ${apiKey ? apiKey.substring(0, 10) + '...' : '無'}\n`;
      result += `- 長度: ${apiKey ? apiKey.length : 0} 個字符\n`;
      
      // 測試設置
      const testKey = 'test-key-' + Date.now();
      localStorage.setItem('test_key', testKey);
      const retrieved = localStorage.getItem('test_key');
      result += `- 設置測試: ${retrieved === testKey ? '成功' : '失敗'}\n`;
      localStorage.removeItem('test_key');
      
      output.textContent = result;
    }
    
    // 測試最終修復
    function testFinalFix() {
      const output = document.getElementById('fixOutput');
      let result = `🔧 最終修復測試:\n`;
      
      if (window.finalApiKeyFix) {
        try {
          const success = window.finalApiKeyFix();
          result += `- 函數執行: 成功\n`;
          result += `- 修復結果: ${success ? '成功' : '失敗'}\n`;
        } catch (error) {
          result += `- 函數執行: 失敗\n`;
          result += `- 錯誤: ${error.message}\n`;
        }
      } else {
        result += `- 函數存在: 否\n`;
      }
      
      output.textContent = result;
    }
    
    // 測試緊急修復
    function testUrgentFix() {
      const output = document.getElementById('fixOutput');
      let result = `🔧 緊急修復測試:\n`;
      
      if (window.urgentApiKeyFix) {
        try {
          const success = window.urgentApiKeyFix();
          result += `- 函數執行: 成功\n`;
          result += `- 修復結果: ${success ? '成功' : '失敗'}\n`;
        } catch (error) {
          result += `- 函數執行: 失敗\n`;
          result += `- 錯誤: ${error.message}\n`;
        }
      } else {
        result += `- 函數存在: 否\n`;
      }
      
      output.textContent = result;
    }
    
    // 測試簡單修復
    function testSimpleFix() {
      const output = document.getElementById('fixOutput');
      let result = `🔧 簡單修復測試:\n`;
      
      if (window.simpleApiKeyFix) {
        try {
          const isValid = window.simpleApiKeyFix.check();
          result += `- 檢查函數: 存在\n`;
          result += `- 檢查結果: ${isValid ? '有效' : '無效'}\n`;
          
          const apiKey = window.simpleApiKeyFix.get();
          result += `- 獲取函數: 存在\n`;
          result += `- 獲取結果: ${apiKey ? '成功' : '失敗'}\n`;
        } catch (error) {
          result += `- 函數執行: 失敗\n`;
          result += `- 錯誤: ${error.message}\n`;
        }
      } else {
        result += `- 函數存在: 否\n`;
      }
      
      output.textContent = result;
    }
    
    // 模擬錯誤
    function simulateError() {
      const output = document.getElementById('errorOutput');
      let result = `🚨 錯誤模擬測試:\n`;
      
      // 模擬 console.error
      console.error('API key未設置，請在開發環境中設置API key');
      result += `- 已觸發 console.error\n`;
      
      // 模擬錯誤拋出
      try {
        throw new Error('API key未設置，請在開發環境中設置API key');
      } catch (error) {
        result += `- 已拋出錯誤: ${error.message}\n`;
      }
      
      result += `- 檢查修復腳本是否攔截了這些錯誤\n`;
      
      output.textContent = result;
    }
    
    // 模擬應用程式檢查
    function simulateAppCheck() {
      const output = document.getElementById('errorOutput');
      let result = `🔍 應用程式檢查模擬:\n`;
      
      // 模擬應用程式的檢查邏輯
      const apiKey = window.getApiKey ? window.getApiKey() : null;
      result += `- 調用 getApiKey(): ${apiKey ? '成功' : '失敗'}\n`;
      result += `- 返回值: ${apiKey ? '有效' : '無效'}\n`;
      result += `- 返回值長度: ${apiKey ? apiKey.length : 0} 個字符\n`;
      
      if (apiKey) {
        result += `- 返回值前10個字符: ${apiKey.substring(0, 10)}...\n`;
      }
      
      output.textContent = result;
    }
    
    // 測試錯誤攔截
    function testErrorInterception() {
      const output = document.getElementById('errorOutput');
      let result = `🚨 錯誤攔截測試:\n`;
      
      // 檢查是否有錯誤攔截
      const originalError = console.error;
      let errorIntercepted = false;
      
      console.error = function(...args) {
        const message = args.join(' ');
        if (message.includes('API key未設置')) {
          errorIntercepted = true;
          return; // 不顯示錯誤
        }
        originalError.apply(console, args);
      };
      
      // 觸發錯誤
      console.error('API key未設置，請在開發環境中設置API key');
      
      // 恢復原始 console.error
      console.error = originalError;
      
      result += `- 錯誤攔截: ${errorIntercepted ? '成功' : '失敗'}\n`;
      
      output.textContent = result;
    }
    
    // 顯示詳細狀態
    function showDetailedStatus() {
      const output = document.getElementById('detailedOutput');
      let result = `📊 詳細狀態報告:\n`;
      
      // API key 狀態
      const apiKey = localStorage.getItem('google_ai_api_key');
      result += `API Key 狀態:\n`;
      result += `- 存在: ${apiKey ? '是' : '否'}\n`;
      result += `- 長度: ${apiKey ? apiKey.length : 0} 個字符\n`;
      result += `- 格式: ${apiKey && apiKey.length >= 30 ? '正確' : '錯誤'}\n`;
      
      // 函數狀態
      result += `\n函數狀態:\n`;
      result += `- getApiKey: ${typeof window.getApiKey === 'function' ? '存在' : '不存在'}\n`;
      result += `- finalApiKeyFix: ${typeof window.finalApiKeyFix === 'function' ? '存在' : '不存在'}\n`;
      result += `- urgentApiKeyFix: ${typeof window.urgentApiKeyFix === 'function' ? '存在' : '不存在'}\n`;
      result += `- simpleApiKeyFix: ${window.simpleApiKeyFix ? '存在' : '不存在'}\n`;
      
      // 頁面狀態
      result += `\n頁面狀態:\n`;
      result += `- DOM 載入: ${document.readyState}\n`;
      result += `- body 存在: ${document.body ? '是' : '否'}\n`;
      result += `- root 元素: ${document.querySelector('#root') ? '存在' : '不存在'}\n`;
      
      output.textContent = result;
    }
    
    // 清除所有測試
    function clearAll() {
      document.getElementById('basicOutput').textContent = '已清除...';
      document.getElementById('fixOutput').textContent = '已清除...';
      document.getElementById('errorOutput').textContent = '已清除...';
      document.getElementById('detailedOutput').textContent = '已清除...';
    }
    
    // 頁面載入時初始化
    document.addEventListener('DOMContentLoaded', () => {
      updateStatus();
      console.log('🧪 API Key 測試頁面已載入');
    });
  </script>
</body>
</html>
